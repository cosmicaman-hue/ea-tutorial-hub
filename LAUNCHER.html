<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EA System Launcher</title>
    <style>
        :root {
            --ink: #0f2c2a;
            --ink-soft: #4c5d5b;
            --paper: #f4f6f5;
            --card: #ffffff;
            --accent: #1e8a70;
            --accent-dark: #176d59;
            --warn: #b45309;
            --ok: #166534;
            --err: #991b1b;
            --shadow: 0 18px 40px rgba(12, 24, 20, 0.18);
            --radius: 16px;
            --font-body: "Bahnschrift", "Trebuchet MS", "Verdana", sans-serif;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: var(--font-body);
            color: var(--ink);
            min-height: 100vh;
            background:
                radial-gradient(600px 400px at 10% 10%, rgba(30, 138, 112, 0.18), transparent 70%),
                radial-gradient(520px 360px at 90% 15%, rgba(14, 165, 233, 0.18), transparent 70%),
                linear-gradient(135deg, #fdf8ef 0%, #e9f1ee 45%, #f6efe4 100%);
            display: grid;
            place-items: center;
            padding: 28px 18px;
        }

        .card {
            width: min(760px, 100%);
            background: var(--card);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            padding: 26px 28px 24px;
            border: 1px solid rgba(30, 138, 112, 0.08);
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .card::before,
        .card::after {
            content: "";
            position: absolute;
            border-radius: 999px;
            opacity: 0.35;
            z-index: 0;
            pointer-events: none;
        }

        .card::before {
            width: 280px;
            height: 280px;
            background: radial-gradient(circle, rgba(30, 138, 112, 0.45), transparent 70%);
            top: -160px;
            left: -120px;
            animation: floatGlow 14s ease-in-out infinite;
        }

        .card::after {
            width: 240px;
            height: 240px;
            background: radial-gradient(circle, rgba(14, 165, 233, 0.38), transparent 70%);
            bottom: -140px;
            right: -120px;
            animation: floatGlow 16s ease-in-out infinite reverse;
        }

        @keyframes floatGlow {
            0% { transform: translateY(0); }
            50% { transform: translateY(18px); }
            100% { transform: translateY(0); }
        }

        h1 {
            font-size: 28px;
            margin-bottom: 6px;
            letter-spacing: 0.6px;
            text-transform: uppercase;
            position: relative;
            z-index: 1;
        }

        p {
            color: var(--ink-soft);
            line-height: 1.5;
            position: relative;
            z-index: 1;
        }

        .actions {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin: 16px 0 6px;
            justify-content: center;
            position: relative;
            z-index: 1;
        }

        button {
            border: none;
            border-radius: 10px;
            padding: 11px 14px;
            font-size: 13px;
            font-weight: 700;
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        button:hover:not([disabled]) {
            transform: translateY(-1px);
            box-shadow: 0 12px 20px rgba(23, 109, 89, 0.2);
        }

        button[disabled] {
            cursor: not-allowed;
            opacity: 0.55;
            box-shadow: none;
            transform: none;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--accent) 0%, #2fb694 100%);
            color: #fff;
        }

        .btn-ghost {
            background: #f7f4ec;
            border: 1px solid rgba(30, 138, 112, 0.28);
            color: var(--accent-dark);
        }

        .status {
            margin-top: 14px;
            padding: 14px 16px;
            border-radius: 12px;
            background: #f8faf9;
            border: 1px solid rgba(30, 138, 112, 0.1);
            position: relative;
            z-index: 1;
            text-align: center;
        }

        .status-row {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 8px;
            justify-content: center;
        }

        .pill {
            padding: 5px 10px;
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            font-weight: 800;
            border-radius: 999px;
            background: #fef3c7;
            color: var(--warn);
        }

        .pill.running {
            background: #dcfce7;
            color: var(--ok);
        }

        .pill.error {
            background: #fee2e2;
            color: var(--err);
        }

        .status-title {
            font-weight: 700;
            margin-bottom: 4px;
        }

        .status-hint {
            font-size: 12px;
            color: #64726f;
        }

        .meta {
            margin-top: 8px;
            font-size: 12px;
            color: #6a7673;
        }

        .creds {
            margin-top: 14px;
            padding: 10px 12px;
            border-radius: 10px;
            background: #fff7ec;
            border: 1px solid rgba(245, 158, 11, 0.25);
            font-size: 12px;
            color: #6a3b00;
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            justify-content: center;
            position: relative;
            z-index: 1;
        }

        .toast {
            position: fixed;
            bottom: 18px;
            left: 50%;
            transform: translateX(-50%);
            background: #183835;
            color: #fff;
            padding: 10px 16px;
            border-radius: 999px;
            font-size: 13px;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s ease;
        }

        .toast.show {
            opacity: 1;
        }

        @media (max-width: 640px) {
            h1 {
                font-size: 24px;
            }

            .card {
                padding: 22px;
            }
        }
    </style>
</head>
<body>
    <main class="card">
        <h1>EA System Launcher</h1>
        <p>Start the system and open the LAN login page for teachers and students.</p>

        <div class="actions">
            <button class="btn-primary" id="launchBtn" type="button" onclick="launchSystem()">Start System</button>
            <button class="btn-ghost" type="button" onclick="openUrl('/ea')" data-requires="server">Open Login Page</button>
            <button class="btn-ghost" type="button" onclick="copyLocalUrl()">Copy LAN Link</button>
            <button class="btn-ghost" type="button" onclick="checkServer(true)">Recheck</button>
        </div>

        <section class="status">
            <div class="status-row">
                <span id="statusPill" class="pill">Checking</span>
                <span class="meta" id="lastCheck">Last check: --</span>
            </div>
            <div id="statusText" class="status-title">Checking system availability...</div>
            <div id="statusHint" class="status-hint">Start the server to enable the LAN link.</div>
            <div class="meta">Local time: <span id="localTime">--</span></div>
        </section>

        <div class="creds">
            <strong>Admin:</strong> Admin / 917511
            <span>|</span>
            <strong>Teacher:</strong> Teacher / EA25T01
            <span>|</span>
            <strong>LAN Link:</strong> http://127.0.0.1:5000/ea
        </div>
    </main>

    <div id="toast" class="toast">Copied</div>

    <script>
        const SERVER_URL = 'http://127.0.0.1:5000';
        const CHECK_INTERVAL = 12000;
        let autoCheckTimer = null;

        const statusPill = document.getElementById('statusPill');
        const statusText = document.getElementById('statusText');
        const statusHint = document.getElementById('statusHint');
        const lastCheck = document.getElementById('lastCheck');
        const localTime = document.getElementById('localTime');
        const toast = document.getElementById('toast');

        function setStatus(type, message, hint) {
            statusPill.className = 'pill ' + type;
            if (type === 'running') {
                statusPill.textContent = 'Ready';
            } else if (type === 'error') {
                statusPill.textContent = 'Offline';
            } else {
                statusPill.textContent = 'Checking';
            }
            statusText.textContent = message;
            statusHint.textContent = hint || '';
        }

        function updateLastCheck() {
            const now = new Date();
            lastCheck.textContent = 'Last check: ' + now.toLocaleTimeString();
        }

        function updateClock() {
            const now = new Date();
            localTime.textContent = now.toLocaleString();
        }

        function toggleServerButtons(enabled) {
            const buttons = document.querySelectorAll('[data-requires="server"]');
            buttons.forEach((btn) => {
                btn.disabled = !enabled;
            });
        }

        function pingServer() {
            return new Promise((resolve) => {
                const timeout = setTimeout(() => resolve(false), 1500);
                fetch(SERVER_URL + '/scoreboard/offline', {
                    method: 'HEAD',
                    mode: 'no-cors',
                    cache: 'no-store'
                })
                .then(() => {
                    clearTimeout(timeout);
                    resolve(true);
                })
                .catch(() => {
                    clearTimeout(timeout);
                    resolve(false);
                });
            });
        }

        function checkServer(manual = false) {
            setStatus('checking', manual ? 'Rechecking system status...' : 'Checking system availability...', 'Waiting for the local server response.');
            return pingServer().then((ok) => {
                updateLastCheck();
                if (ok) {
                    setStatus('running', 'System ready. Open the login page.', 'LAN link is available.');
                    toggleServerButtons(true);
                } else {
                    setStatus('error', 'Server not detected. Start the system to continue.', 'Click Start System or run run_server.bat manually.');
                    toggleServerButtons(false);
                }
                return ok;
            });
        }

        function startAutoCheck() {
            if (autoCheckTimer) {
                clearInterval(autoCheckTimer);
            }
            autoCheckTimer = setInterval(() => checkServer(false), CHECK_INTERVAL);
        }

        function showToast(message) {
            toast.textContent = message;
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 1600);
        }

        function openUrl(path) {
            const url = path.startsWith('http') ? path : SERVER_URL + path;
            window.open(url, '_blank', 'noopener');
        }

        function copyLocalUrl() {
            const url = SERVER_URL + '/ea';
            if (navigator.clipboard) {
                navigator.clipboard.writeText(url).then(() => showToast('LAN link copied'));
            } else {
                showToast('Clipboard not available');
            }
        }

        function launchSystem() {
            const btn = document.getElementById('launchBtn');
            btn.disabled = true;
            setStatus('checking', 'Starting system...', 'This can take 10 to 15 seconds.');

            try {
                if (window.ActiveXObject) {
                    const shell = new ActiveXObject('WScript.Shell');
                    const filePath = decodeURIComponent(window.location.pathname || '');
                    const basePath = filePath.replace(/[\\/][^\\/]*$/, '').replace(/^\/([A-Za-z]:)/, '$1');
                    const batPath = (basePath + '\\run_server.bat').replace(/\//g, '\\');
                    shell.Run(batPath, 0, false);
                } else if (window.location.protocol === 'file:') {
                    // Browser sandbox cannot execute .bat directly; open it so user can run with one click.
                    window.open('./run_server.bat', '_blank');
                    setStatus('checking', 'Open the downloaded/run_server file prompt.', 'After allowing it, click Recheck.');
                } else {
                    setStatus('error', 'Auto-start is available only on local launcher.', 'On this PC, run run_server.bat once.');
                    btn.disabled = false;
                    return;
                }
            } catch (e) {
                setStatus('error', 'Auto-start failed. Run run_server.bat manually.', 'After starting, click Recheck.');
                btn.disabled = false;
                return;
            }

            pollServer(0);
        }

        function pollServer(attempt) {
            const maxAttempts = 15;
            pingServer().then((ok) => {
                if (ok) {
                    setStatus('running', 'System ready. Open the login page.', 'LAN link is available.');
                    toggleServerButtons(true);
                    document.getElementById('launchBtn').disabled = false;
                } else if (attempt < maxAttempts) {
                    setStatus('checking', 'Starting system... (' + (attempt + 1) + '/' + maxAttempts + ')', 'Waiting for the server to come online.');
                    setTimeout(() => pollServer(attempt + 1), 1000);
                } else {
                    setStatus('error', 'Server taking longer than expected.', 'Run run_server.bat manually and click Recheck.');
                    document.getElementById('launchBtn').disabled = false;
                }
            });
        }

        window.addEventListener('load', () => {
            updateClock();
            setInterval(updateClock, 1000);
            toggleServerButtons(false);
            checkServer(false);
            startAutoCheck();
        });
    </script>
</body>
</html>
