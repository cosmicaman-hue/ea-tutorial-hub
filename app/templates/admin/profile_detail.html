{% extends "base.html" %}

{% block title %}Student Profile - {{ user.login_id }}{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-md-8">
            <h2>üë§ Student Profile</h2>
            <p class="text-muted">Login ID: <strong>{{ user.login_id }}</strong></p>
        </div>
        <div class="col-md-4 text-end">
            <a href="{{ url_for('profile_viewer.view_all_profiles') }}" class="btn btn-secondary">
                <i class="fas fa-arrow-left"></i> Back
            </a>
        </div>
    </div>

    <!-- Personal Information -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">üë§ Personal Information</h5>
                </div>
                <div class="card-body">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <p class="text-muted small">First Name</p>
                            <p><strong>{{ profile.first_name or 'Not set' }}</strong></p>
                        </div>
                        <div class="col-md-6">
                            <p class="text-muted small">Second Name</p>
                            <p><strong>{{ profile.second_name or 'Not set' }}</strong></p>
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <p class="text-muted small">Third Name</p>
                            <p><strong>{{ profile.third_name or 'Not set' }}</strong></p>
                        </div>
                        <div class="col-md-6">
                            <p class="text-muted small">Gender</p>
                            <p><strong>{{ profile.gender or 'Not set' }}</strong></p>
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <p class="text-muted small">Date of Birth</p>
                            <p><strong>{{ profile.date_of_birth.strftime('%d-%m-%Y') if profile.date_of_birth else 'Not set' }}</strong></p>
                        </div>
                        <div class="col-md-6">
                            <p class="text-muted small">Nationality</p>
                            <p><strong>{{ profile.nationality or 'Not set' }}</strong></p>
                        </div>
                    </div>
                    <div class="mb-3">
                        <p class="text-muted small">Religion</p>
                        <p><strong>{{ profile.religion or 'Not set' }}</strong></p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Contact Information -->
        <div class="col-md-6">
            <div class="card">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0">üìû Contact Information</h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <p class="text-muted small">Email</p>
                        <p>
                            {% if profile.email %}
                            <a href="mailto:{{ profile.email }}"><strong>{{ profile.email }}</strong></a>
                            {% else %}
                            <em class="text-muted">Not set</em>
                            {% endif %}
                        </p>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <p class="text-muted small">Phone 1</p>
                            <p><strong>{{ profile.contact_number_1 or 'Not set' }}</strong></p>
                        </div>
                        <div class="col-md-6">
                            <p class="text-muted small">Phone 2</p>
                            <p><strong>{{ profile.contact_number_2 or 'Not set' }}</strong></p>
                        </div>
                    </div>
                    <div class="mb-3">
                        <p class="text-muted small">Village/Area</p>
                        <p><strong>{{ profile.village_area or 'Not set' }}</strong></p>
                    </div>
                    <div class="mb-3">
                        <p class="text-muted small">Post Office</p>
                        <p><strong>{{ profile.post_office or 'Not set' }}</strong></p>
                    </div>
                    <div class="mb-3">
                        <p class="text-muted small">District</p>
                        <p><strong>{{ profile.district or 'Not set' }}</strong></p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Academic Information -->
    <div class="row mb-4">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0">üéì Academic Information</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3">
                            <p class="text-muted small">School Name</p>
                            <p><strong>{{ profile.school_name or 'Not set' }}</strong></p>
                        </div>
                        <div class="col-md-3">
                            <p class="text-muted small">Class</p>
                            <p><strong>{{ profile.class_name or 'Not set' }}</strong></p>
                        </div>
                        <div class="col-md-3">
                            <p class="text-muted small">Section</p>
                            <p><strong>{{ profile.section or 'Not set' }}</strong></p>
                        </div>
                        <div class="col-md-3">
                            <p class="text-muted small">Roll Number</p>
                            <p><strong>{{ profile.roll_number or 'Not set' }}</strong></p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Account Status -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header bg-warning text-dark">
                    <h5 class="mb-0">üîê Account Status</h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <p class="text-muted small">Account Status</p>
                        <p>
                            {% if user.is_active %}
                            <span class="badge bg-success">Active</span>
                            {% else %}
                            <span class="badge bg-danger">Inactive</span>
                            {% endif %}
                        </p>
                    </div>
                    <div class="mb-3">
                        <p class="text-muted small">Account Created</p>
                        <p><strong>{{ user.created_at.strftime('%d-%m-%Y %H:%M:%S') if user.created_at else '-' }}</strong></p>
                    </div>
                    <div class="mb-3">
                        <p class="text-muted small">Last Login</p>
                        <p><strong>{{ user.last_login.strftime('%d-%m-%Y %H:%M:%S') if user.last_login else 'Never' }}</strong></p>
                    </div>
                    <div class="mb-3">
                        <p class="text-muted small">Last Login IP</p>
                        <p><strong>{{ user.last_login_ip or '-' }}</strong></p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Quick Actions -->
        <div class="col-md-6">
            <div class="card">
                <div class="card-header bg-secondary text-white">
                    <h5 class="mb-0">‚öôÔ∏è Quick Actions</h5>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        <a href="{{ url_for('admin.reset_password', user_id=user.id) }}" class="btn btn-warning">
                            <i class="fas fa-key"></i> Reset Password
                        </a>
                        <button class="btn btn-danger" onclick="toggleStatus()">
                            <i class="fas fa-ban"></i> {% if user.is_active %}Deactivate{% else %}Activate{% endif %} Account
                        </button>
                        <a href="mailto:{{ profile.email }}" class="btn btn-info">
                            <i class="fas fa-envelope"></i> Send Email
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Recent Activities -->
    <div class="row mb-4">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header bg-dark text-white">
                    <h5 class="mb-0">üìä Recent Activities (Last 20)</h5>
                </div>
                <div class="table-responsive">
                    <table class="table table-sm mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>Timestamp</th>
                                <th>Action Type</th>
                                <th>Action</th>
                                <th>Details</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% if activities %}
                                {% for activity in activities %}
                                <tr>
                                    <td><small>{{ activity.timestamp.strftime('%d-%m-%Y %H:%M:%S') }}</small></td>
                                    <td><span class="badge bg-primary">{{ activity.action_type }}</span></td>
                                    <td><strong>{{ activity.action }}</strong></td>
                                    <td><small>{{ activity.details or '-' }}</small></td>
                                </tr>
                                {% endfor %}
                            {% else %}
                            <tr>
                                <td colspan="4" class="text-center text-muted py-3">No activities recorded</td>
                            </tr>
                            {% endif %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Quiz Attempts -->
    <div class="row mb-4">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header bg-dark text-white">
                    <h5 class="mb-0">üìù Quiz Attempts (Last 10)</h5>
                </div>
                <div class="table-responsive">
                    <table class="table table-sm mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>Quiz Title</th>
                                <th>Attempt Date</th>
                                <th>Score</th>
                                <th>Time Taken</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% if quiz_attempts %}
                                {% for attempt in quiz_attempts %}
                                <tr>
                                    <td><strong>{{ attempt.quiz.title if attempt.quiz else '-' }}</strong></td>
                                    <td><small>{{ attempt.attempt_date.strftime('%d-%m-%Y %H:%M:%S') if attempt.attempt_date else '-' }}</small></td>
                                    <td>
                                        <strong>
                                            {% if attempt.obtained_marks and attempt.quiz.total_points %}
                                            {{ ((attempt.obtained_marks / attempt.quiz.total_points) * 100) | round(1) }}%
                                            {% else %}
                                            -
                                            {% endif %}
                                        </strong>
                                    </td>
                                    <td>{{ attempt.time_taken or '-' }}</td>
                                    <td>
                                        {% if attempt.obtained_marks >= attempt.quiz.passing_score %}
                                        <span class="badge bg-success">Passed</span>
                                        {% else %}
                                        <span class="badge bg-danger">Failed</span>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            {% else %}
                            <tr>
                                <td colspan="5" class="text-center text-muted py-3">No quiz attempts</td>
                            </tr>
                            {% endif %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function toggleStatus() {
    const action = '{{ "Deactivate" if user.is_active else "Activate" }}';
    if (confirm(`Are you sure you want to ${action} this account?`)) {
        // Implement account status toggle API call
        console.log(`${action} account for user: {{ user.login_id }}`);
    }
}
</script>

<style>
    .card {
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .badge {
        padding: 0.5rem 0.75rem;
    }
</style>
{% endblock %}
